<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tulis AI dan Photo</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <style>
        body { margin: 0; background: #121212; color: white; font-family: 'Segoe UI', sans-serif; text-align: center; overflow: hidden; }
        h2 { margin: 10px 0; font-size: 1.2rem; }
        
        .container { position: relative; width: 100vw; height: 75vh; display: flex; justify-content: center; }
        
        video, #output_canvas { 
            position: absolute; 
            height: 100%; 
            transform: scaleX(-1); 
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        #ui-tools {
            position: fixed;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 15px;
            z-index: 100;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-snap { background: #00d2d3; color: black; }
        .btn-snap:hover { background: #01a3a4; transform: scale(1.05); }
        
        .btn-clear { background: #ff4757; color: white; }
        .btn-clear:hover { background: #ff6b81; }

        .btn-filter { background:#5352ed; color:white; }
        .btn-color { background:#ffa502; color:black; }

        .status { 
            background: rgba(0,0,0,0.6); 
            padding: 5px 15px; 
            border-radius: 20px; 
            display: inline-block;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>

    <h2>Tulis Tangan dan Ambil Foto</h2>
    <div id="status" class="status">Menyiapkan AI Kamera...</div>

    <div class="container">
        <video id="input_video" style="display:none;"></video>
        <canvas id="output_canvas"></canvas>
    </div>

    <div id="ui-tools">
        <button class="btn-clear" onclick="clearCanvas()">
            <i class="fas fa-trash-alt"></i> Hapus Tulisan
        </button>
        <button class="btn-snap" onclick="takePhoto()">
            <i class="fas fa-camera"></i> Ambil Foto
        </button>
        <button class="btn-filter" onclick="changeFilter()">
            <i class="fas fa-magic"></i> Filter
        </button>
        <button class="btn-color" id="colorBtn" onclick="changeColor()">
            <i class="fas fa-palette"></i> Warna
        </button>
    </div>

<script>
const videoElement = document.getElementById('input_video');
const canvasElement = document.getElementById('output_canvas');
const canvasCtx = canvasElement.getContext('2d');
const statusText = document.getElementById('status');

// Canvas terpisah untuk coretan permanen
const drawCanvas = document.createElement('canvas');
const drawCtx = drawCanvas.getContext('2d');

let lastX = 0;
let lastY = 0;

/* FILTER */
let filters = ["none","grayscale(100%)","sepia(100%)","contrast(150%)","invert(100%)","hue-rotate(180deg)"];
let currentFilter = 0;

/* WARNA */
let colors = ["#00FFCC","#ff4757","#1e90ff","#ffa502","#ffffff"];
let currentColor = 0;

function changeFilter(){
    currentFilter++;
    if(currentFilter >= filters.length) currentFilter = 0;
}

function changeColor(){
    currentColor++;
    if(currentColor >= colors.length) currentColor = 0;
    // Update warna tombol agar user tahu warna yang aktif
    document.getElementById('colorBtn').style.backgroundColor = colors[currentColor];
}

function onResults(results) {
    // Pastikan ukuran canvas sinkron dengan video
    if (canvasElement.width !== videoElement.videoWidth) {
        canvasElement.width = drawCanvas.width = videoElement.videoWidth;
        canvasElement.height = drawCanvas.height = videoElement.videoHeight;
    }

    canvasCtx.save();
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

    // Terapkan Filter pada Video
    canvasCtx.filter = filters[currentFilter];
    canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
    canvasCtx.filter = "none"; // Reset filter agar tidak kena ke tulisan

    if (results.multiHandLandmarks) {
        statusText.innerText = "Kamera Siap! Gunakan Telunjuk.";
        for (const landmarks of results.multiHandLandmarks) {

            const indexFinger = landmarks[8];
            const x = indexFinger.x * canvasElement.width;
            const y = indexFinger.y * canvasElement.height;

            const middleFinger = landmarks[12];

            /* GESTURE: TELUNJUK SAJA = NULIS */
            if (indexFinger.y < landmarks[6].y && middleFinger.y > landmarks[10].y) {
                if (lastX !== 0) {
                    drawCtx.strokeStyle = colors[currentColor];
                    drawCtx.lineWidth = 6;
                    drawCtx.lineCap = "round";
                    drawCtx.beginPath();
                    drawCtx.moveTo(lastX, lastY);
                    drawCtx.lineTo(x, y);
                    drawCtx.stroke();
                }
                lastX = x;
                lastY = y;

            /* GESTURE: KEPALAN (Jari telunjuk & tengah turun) = HAPUS */
            } else if (indexFinger.y > landmarks[6].y && middleFinger.y > landmarks[10].y) {
                clearCanvas();
                statusText.innerText = "Gesture Kepalan: Menghapus...";
                lastX = 0;
                lastY = 0;
            } else {
                // Angkat jari (Pena diangkat)
                lastX = 0;
                lastY = 0;
            }

            // Gambar titik kursor (Pointer)
            canvasCtx.fillStyle = colors[currentColor];
            canvasCtx.beginPath();
            canvasCtx.arc(x, y, 8, 0, 2 * Math.PI);
            canvasCtx.fill();
            canvasCtx.strokeStyle = "white";
            canvasCtx.lineWidth = 2;
            canvasCtx.stroke();
        }
    }

    // Gambar hasi coretan permanen di atas video
    canvasCtx.drawImage(drawCanvas, 0, 0);
    canvasCtx.restore();
}

/* Setup MediaPipe Hands */
const hands = new Hands({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});

hands.setOptions({
    maxNumHands: 1,
    modelComplexity: 1,
    minDetectionConfidence: 0.7,
    minTrackingConfidence: 0.7
});

hands.onResults(onResults);

const camera = new Camera(videoElement, {
    onFrame: async () => {
        await hands.send({image: videoElement});
    },
    width: 1280,
    height: 720
});
camera.start();

function clearCanvas() {
    drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
}

function takePhoto() {
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = canvasElement.width;
    tempCanvas.height = canvasElement.height;
    const tempCtx = tempCanvas.getContext('2d');

    // Proses Mirror agar hasil foto tidak terbalik (tulisan bisa dibaca)
    tempCtx.translate(tempCanvas.width, 0);
    tempCtx.scale(-1, 1);
    tempCtx.drawImage(canvasElement, 0, 0);

    const link = document.createElement('a');
    link.download = `foto-udara-${Date.now()}.png`;
    link.href = tempCanvas.toDataURL('image/png');
    link.click();
    
    statusText.innerText = "Foto Berhasil Disimpan!";
}
</script>

</body>
</html>